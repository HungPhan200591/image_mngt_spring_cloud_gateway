spring:
  cloud:
    gateway:
      default-filters:
        - name: CircuitBreaker
          args:
            name: defaultCircuitBreaker
            fallbackUri: forward:/fallback
        - name: Retry
          args:
            retries: 3
            series: SERVER_ERROR
            methods: GET, POST, PUT, DELETE
            statuses: INTERNAL_SERVER_ERROR, BAD_GATEWAY
            backoff:
              firstBackoff: 1000
              maxBackoff: 10000
              factor: 2
#        - name: RequestRateLimiter
#          args:
#            key-resolver: "#{@remoteAddressKeyResolver}"  # Sử dụng IP của client để giới hạn
#            rate-limiter: "#{@inMemoryRateLimiter}"       # Sử dụng InMemoryRateLimiter

#            - name: RequestRateLimiter
#              args:
#                redis-rate-limiter.replenishRate: 10  # Số lượng yêu cầu tối đa mỗi giây
#                redis-rate-limiter.burstCapacity: 20  # Số lượng yêu cầu tối đa trong hàng đợi chờ xử lý

      routes:
        - id: auth-service
          uri: http://localhost:8081
          predicates:
            - Path=/api/v1/auth/**

        - id: image-service-image-detail
          uri: http://localhost:8082
          predicates:
            - Path=/api/v1/file/image/{image_id}
          filters:
            - ImageDetailFilter

        - id: image-service
          uri: http://localhost:8082
          predicates:
            - Path=/api/v1/file/image/**



resilience4j:
  circuitbreaker:
    configs:
      default:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10000
        permitted-number-of-calls-in-half-open-state: 3
        sliding-window-type: COUNT_BASED

  bulkhead:
    configs:
      default:
        maxConcurrentCalls: 10  # Số lượng luồng đồng thời tối đa
        maxWaitDuration: 5s     # Thời gian chờ tối đa trong hàng đợi

logging:
  level:
    org.springframework.cloud.gateway: DEBUG
